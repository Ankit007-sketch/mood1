const DATA_PATH="./data.json";let DATA=null;let currentMoodKey=null;let quoteIndex=0;let quoteTimer=null;async function init(){showLastMood();try{const r=await fetch(DATA_PATH);DATA=await r.json()}catch(e){console.error("Failed to load data.json",e);alert("Failed to load data.json â€” check Live Server or fetch permissions.");return}renderMoodGrid();const t=localStorage.getItem("moodKey");if(t&&DATA.moods[t])selectMood(t,!0);const savedTheme=localStorage.getItem('theme')||'dark';applyTheme(savedTheme);const tbtn=document.getElementById('themeToggle');if(tbtn)tbtn.addEventListener('click',toggleTheme)}function showLastMood(){const e=document.getElementById("lastMoodChip");const t=localStorage.getItem("moodKey");e.textContent=t?`Remembered: ${t}`:"Remembered: â€”"}function renderMoodGrid(){const e=document.getElementById("moodGrid");e.innerHTML="";for(const t of Object.keys(DATA.moods)){const n=DATA.moods[t];const o=document.createElement("button");o.className="mood-card";o.setAttribute("data-key",t);o.innerHTML=`<div class="mood-emoji">${n.emoji}</div><div class="mood-name">${n.name}</div>`;o.addEventListener("click",(()=>selectMood(t)));e.appendChild(o)}}function selectMood(key,silent=false){if(!DATA||!DATA.moods[key])return;currentMoodKey=key;localStorage.setItem("moodKey",key);showLastMood();const grid=document.getElementById("moodGrid");Array.from(grid.children).forEach(c=>c.style.opacity=c.getAttribute("data-key")==key?"1":"0.6");const area=document.getElementById("contentArea");area.style.display="block";const mood=DATA.moods[key];document.getElementById("selectedMoodTitle").textContent=`${mood.emoji} ${mood.name}`;document.getElementById("selectedMoodSubtitle").textContent=`${mood.songs.length} songs â€¢ ${mood.quotes.length} quotes`;renderSongs(mood.songs);startQuotesCarousel(mood.quotes);if(!silent)window.scrollTo({top:area.getBoundingClientRect().top+window.scrollY-40,behavior:"smooth"})}function renderSongs(songs){const wrap=document.getElementById("songs");wrap.innerHTML="";songs.forEach(s=>{const el=document.createElement("div");el.className="song-card";const yt=extractYoutubeId(s.url);el.innerHTML=`<div class="play-btn" data-url="${yt?"https://www.youtube.com/embed/"+yt+"?autoplay=1":s.url}">â–¶</div><div class="song-meta"><div class="font-semibold">${s.title}</div><div class="text-sm opacity-80">${s.artist}</div></div>`;el.querySelector(".play-btn").addEventListener("click",e=>openPlayer(e.target.getAttribute("data-url")));wrap.appendChild(el)})}function extractYoutubeId(url){try{const e=new URL(url);if(e.hostname.includes("youtube.com"))return e.searchParams.get("v");if(e.hostname.includes("youtu.be"))return e.pathname.slice(1)}catch(e){}return null}function openPlayer(src){const modal=document.getElementById("modal");const frame=document.getElementById("playerFrame");frame.src=src;modal.style.display="flex"}document.getElementById("closeModal").addEventListener("click",(()=>{const e=document.getElementById("modal");const t=document.getElementById("playerFrame");t.src="";e.style.display="none"}));document.getElementById("resetBtn").addEventListener("click",(()=>{localStorage.removeItem("moodKey");showLastMood();document.getElementById("contentArea").style.display="none";document.getElementById("moodGrid").querySelectorAll(".mood-card").forEach(c=>c.style.opacity="1")}));document.getElementById("shareBtn").addEventListener("click",(()=>{if(!currentMoodKey)return alert("Select a mood first");const e=DATA.moods[currentMoodKey];const t=encodeURIComponent(`Check out how ${e.name} mood feels â€” ${location.href}`);const n=`https://twitter.com/intent/tweet?text=${t}`;window.open(n,"_blank")}));function startQuotesCarousel(quotes){if(quoteTimer)clearInterval(quoteTimer);quoteIndex=0;const el=document.getElementById("quoteText");function show(){const txt=quotes[quoteIndex%quotes.length];typeText(el,txt);quoteIndex++}show();quoteTimer=setInterval(show,4500)}function typeText(el,text){el.textContent="";let i=0;const id=setInterval(()=>{el.textContent+=text[i++]||"";if(i>text.length)clearInterval(id)},28)}if("serviceWorker"in navigator){window.addEventListener("load",()=>{navigator.serviceWorker.register("sw.js",{scope:"./"}).catch(e=>console.warn("SW failed",e))})}window.addEventListener("DOMContentLoaded",init);function applyTheme(e){document.documentElement.setAttribute("data-theme",e);var t=document.getElementById("themeToggle");if(t)t.textContent=e==="light"?"ðŸŒž":"ðŸŒ™"}function toggleTheme(){var e=document.documentElement.getAttribute("data-theme")||"dark",t=e==="light"?"dark":"light";document.documentElement.classList.add('light-transition');var n=document.getElementById('themeToggle');if(n)n.classList.add('spinning');document.body.classList.add('theme-flash');localStorage.setItem("theme",t);applyTheme(t);setTimeout(()=>{document.documentElement.classList.remove('light-transition');if(n)n.classList.remove('spinning');document.body.classList.remove('theme-flash')},500)}
